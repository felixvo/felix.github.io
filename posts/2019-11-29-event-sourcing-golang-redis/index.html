<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Event Sourcing with Go and Redis | Hi</title><meta name=keywords content><meta name=description content="I thought you already heard about Event Sourcing in the past recent year.
But let&rsquo;s go through the definition again.

Capture all changes to an application state as a sequence of events.
Event Sourcing ensures that all changes to application state are stored as a sequence of events. - Martin Fowler
"><meta name=author content="Me"><link rel=canonical href=https://felixvo.github.io/posts/2019-11-29-event-sourcing-golang-redis/><link crossorigin=anonymous href=/assets/css/stylesheet.1740750342264a4e69b84ddf6899fb02cc95465080d85c57c08bb1d110900bf6.css integrity="sha256-F0B1A0ImSk5puE3faJn7AsyVRlCA2FxXwIux0RCQC/Y=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://felixvo.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://felixvo.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://felixvo.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://felixvo.github.io/apple-touch-icon.png><link rel=mask-icon href=https://felixvo.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="Event Sourcing with Go and Redis"><meta property="og:description" content="I thought you already heard about Event Sourcing in the past recent year.
But let&rsquo;s go through the definition again.

Capture all changes to an application state as a sequence of events.
Event Sourcing ensures that all changes to application state are stored as a sequence of events. - Martin Fowler
"><meta property="og:type" content="article"><meta property="og:url" content="https://felixvo.github.io/posts/2019-11-29-event-sourcing-golang-redis/"><meta property="og:image" content="https://felixvo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://felixvo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Event Sourcing with Go and Redis"><meta name=twitter:description content="I thought you already heard about Event Sourcing in the past recent year.
But let&rsquo;s go through the definition again.

Capture all changes to an application state as a sequence of events.
Event Sourcing ensures that all changes to application state are stored as a sequence of events. - Martin Fowler
"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://felixvo.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Event Sourcing with Go and Redis","item":"https://felixvo.github.io/posts/2019-11-29-event-sourcing-golang-redis/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Event Sourcing with Go and Redis","name":"Event Sourcing with Go and Redis","description":"I thought you already heard about Event Sourcing in the past recent year. But let\u0026rsquo;s go through the definition again.\nCapture all changes to an application state as a sequence of events. Event Sourcing ensures that all changes to application state are stored as a sequence of events. - Martin Fowler\n","keywords":[],"articleBody":"I thought you already heard about Event Sourcing in the past recent year. But let’s go through the definition again.\nCapture all changes to an application state as a sequence of events. Event Sourcing ensures that all changes to application state are stored as a sequence of events. - Martin Fowler\nIf you know bitcoin/blockchain you will know it’s quite similar with Event Sourcing.\nYour current balance (Application State) is calculated from a series of events in history (in the chain) so you don’t have a table like this in database\nuser_id balance 10 100$ 7 200$ now you have\nevents user x top-up event user buy 5 items event user y top-up event I’ve read many articles/blog posts about Event Sourcing so I try to make once.\nWhat we will build? Let’s say you have an e-commerce website and users can buy items from your website.\nSource: https://github.com/felixvo/lmax\nNOTE: This code is not tested, just an experiment\nEntities:\nUser will have balance. Item will have price and number of remain items in the warehouse. Events:\nTopup: increase user balance AddItem: add more item to warehouse Order: buy items Directory Structure ├── cmd │ ├── consumer # process events │ │ ├── handler # handle new event base on event Type │ │ └── state │ └── producer # publish events └── pkg ├── event # event definition ├── snapshot # snapshot state of the app ├── user # user domain └── warehouse # item domain Architecture Event storage: Redis Stream Entry IDs The entry ID returned by the XADD command, and identifying univocally \u003eeach entry inside a given stream, is composed of two parts:\n- I use this Entry ID to keep track of processed event\nThe consumer will consume events and build the application state snapshot package will take the application state and save to redis every 30s. Application state will restore from this if our app crash The Producer Use XAdd cmd to add data to a stream\nfunc Topup(client *redis.Client) { for i := 0; i \u003c 10; i++ { userID := int64(rand.Intn(MaxUserIDRange)) strCMD := client.XAdd(\u0026redis.XAddArgs{ Stream: \"orders\", Values: map[string]interface{}{ \"type\": string(event.TopUpType), \"data\": \u0026event.TopUp{ Base: \u0026event.Base{ Type: event.TopUpType, }, UserID: userID, Amount: 500, }, }, }) newID, err := strCMD.Result() if err != nil { fmt.Printf(\"topup error:%v\\n\", err) } else { fmt.Printf(\"topup success for user:%v offset:%v\\n\", userID, newID) } } } The State The state object is pretty simple, just a plain struct\ntype State struct { LatestEventID string Users map[int64]*user.User Items map[string]*warehouse.Item } The Consumer Then the Consumer gets the events =\u003e pass the event proper handler\nfunc consumeEvents(events chan event.Event, handlerFactory func(t event.Type) handler.Handler) { for { select { case e := \u003c-events: h := handlerFactory(e.GetType()) err := h.Handle(e) if err != nil { fmt.Printf(\"handle event error eventType:%v err:%v\\n\", e.GetType(), err) } } } } Depend on event.Type, we have different handlers for each event type. And the handler will handle the business logic then update the state\nhandler/ factory.go handler.go item_add.go log.go order.go topup.go handler/topup.go\nfunc (h *topupHandler) Handle(e event.Event) error { topup, ok := e.(*event.TopUp) defer func() { h.state.LatestEventID = topup.GetID() }() if !ok { return fmt.Errorf(\"incorrect event type\") } u, exist := h.state.Users[topup.UserID] if !exist { // should have an event to create user before use u = \u0026user.User{ UseID: topup.UserID, Balance: 0, } h.state.Users[topup.UserID] = u } u.Balance += topup.Amount fmt.Printf(\"completed topup %+v \\n\", topup) return nil } handler/item_add.go\nfunc (h *itemAddHandler) Handle(e event.Event) error { addItem, ok := e.(*event.AddItem) defer func() { h.state.LatestEventID = addItem.GetID() }() if !ok { return fmt.Errorf(\"incorrect event type\") } i, exist := h.state.Items[addItem.ItemID] if !exist { i = \u0026warehouse.Item{ ID: addItem.ItemID, Price: uint(rand.Intn(100)), Remain: uint(rand.Intn(200)), } h.state.Items[addItem.ItemID] = i } i.Remain += addItem.Count fmt.Printf(\"completed add item %+v \\n\", addItem) return nil } Snapshot the snapshot will take the state and save to redis\nfunc exeSnapshot(st *state.State, snapshotSrv snapshot.Snapshot) { ticker := time.Tick(time.Second * 30) for { select { case \u003c-ticker: err := snapshotSrv.Snapshot(st) if err != nil { fmt.Println(\"snapshot failed:\", err) break } fmt.Println(\"snapshot success:\", st.LatestEventID, \" at \", time.Now()) } } } Run Require redis running locally\nProducer First, start the producer to insert some events to redis stream Consumer Now start the consumer to consume events\nBecause the consumer consumes the events but not backup the state yet. If you wait for more than 30s, you will see this message from console\nNow if you stop the app and start it again, the application state will restore from the latest snapshot, not reprocess the event again\nThank you for reading! I hope the source code is clean enough for you to understand :scream:\nThoughts Did you curious why I name my repository lmax? By the time I write this post, I’m researching about this LMAX architecture Github. It’s quite interesting. Currently, I fetch new events and push to a channel, we can use LMAX Disruptor to optimize the latency but there is no stable implement of LMAX Disruptor in go.\n","wordCount":"828","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://felixvo.github.io/posts/2019-11-29-event-sourcing-golang-redis/"},"publisher":{"@type":"Organization","name":"Hi","logo":{"@type":"ImageObject","url":"https://felixvo.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://felixvo.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://felixvo.github.io/apple-touch-icon.png alt=logo aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://felixvo.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://felixvo.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://felixvo.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://felixvo.github.io/posts/>Posts</a></div><h1 class=post-title>Event Sourcing with Go and Redis</h1><div class=post-meta>4 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/2019-11-29-event-sourcing-golang-redis.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>I thought you already heard about Event Sourcing in the past recent year.
But let&rsquo;s go through the definition again.</p><blockquote><p>Capture all changes to an application state as a sequence of events.
Event Sourcing ensures that all changes to application state are stored as a sequence of events. - <a href=https://martinfowler.com/eaaDev/EventSourcing.html>Martin Fowler</a></p></blockquote><p>If you know bitcoin/blockchain you will know it&rsquo;s quite similar with Event Sourcing.</p><blockquote><p>Your current balance (Application State) is calculated from a series of events in history (in the chain)
<img loading=lazy src=https://thepracticaldev.s3.amazonaws.com/i/ztik9xqelulsh4lx3kl9.png alt="Alt Text"></p></blockquote><p>so you don&rsquo;t have a table like this in database</p><table><thead><tr><th>user_id</th><th>balance</th></tr></thead><tbody><tr><td>10</td><td>100$</td></tr><tr><td>7</td><td>200$</td></tr></tbody></table><p>now you have</p><table><thead><tr><th>events</th></tr></thead><tbody><tr><td>user x top-up event</td></tr><tr><td>user buy 5 items event</td></tr><tr><td>user y top-up event</td></tr></tbody></table><p>I&rsquo;ve read many articles/blog posts about Event Sourcing so I try to make once.</p><h2 id=what-we-will-build>What we will build?<a hidden class=anchor aria-hidden=true href=#what-we-will-build>#</a></h2><p>Let&rsquo;s say you have an e-commerce website and users can buy items from your website.<br>Source: <a href=https://github.com/felixvo/lmax>https://github.com/felixvo/lmax</a><br>NOTE: This code is not tested, just an experiment</p><p>Entities:</p><ul><li><code>User</code> will have <code>balance</code>.</li><li><code>Item</code> will have <code>price</code> and number of <code>remain</code> items in the <code>warehouse</code>.</li></ul><p>Events:</p><ul><li><code>Topup</code>: increase user balance</li><li><code>AddItem</code>: add more item to <code>warehouse</code></li><li><code>Order</code>: buy items</li></ul><h2 id=directory-structure>Directory Structure<a hidden class=anchor aria-hidden=true href=#directory-structure>#</a></h2><pre tabindex=0><code>├── cmd
│   ├── consumer       # process events
│   │   ├── handler    # handle new event base on event Type
│   │   └── state
│   └── producer       # publish events
└── pkg
    ├── event          # event definition
    ├── snapshot       # snapshot state of the app
    ├── user           # user domain
    └── warehouse      # item domain
</code></pre><h2 id=architecture>Architecture<a hidden class=anchor aria-hidden=true href=#architecture>#</a></h2><p><img loading=lazy src=https://thepracticaldev.s3.amazonaws.com/i/ui1bv7ili5wag324ucil.png alt="Alt Text"></p><ul><li>Event storage: <a href=https://redis.io/topics/streams-intro>Redis Stream</a></li></ul><blockquote><p>Entry IDs
The entry ID returned by the XADD command, and identifying univocally >each entry inside a given stream, is composed of two parts:<br><code>&lt;millisecondsTime>-&lt;sequenceNumber></code>
I use this <code>Entry ID</code> to keep track of processed event</p></blockquote><ul><li>The consumer will consume events and build the application state</li><li><code>snapshot</code> package will take the application state and save to redis every 30s. Application state will restore from this if our app crash</li></ul><h2 id=the-producer>The Producer<a hidden class=anchor aria-hidden=true href=#the-producer>#</a></h2><p>Use <code>XAdd</code> cmd to add data to a stream</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Topup</span><span class=p>(</span><span class=nx>client</span> <span class=o>*</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Client</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>userID</span> <span class=o>:=</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=nx>MaxUserIDRange</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>strCMD</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>XAdd</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>redis</span><span class=p>.</span><span class=nx>XAddArgs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Stream</span><span class=p>:</span> <span class=s>&#34;orders&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Values</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;type&#34;</span><span class=p>:</span> <span class=nb>string</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>TopUpType</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;data&#34;</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>event</span><span class=p>.</span><span class=nx>TopUp</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Base</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>event</span><span class=p>.</span><span class=nx>Base</span><span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>Type</span><span class=p>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>TopUpType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=p>},</span>
</span></span><span class=line><span class=cl>					<span class=nx>UserID</span><span class=p>:</span> <span class=nx>userID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Amount</span><span class=p>:</span> <span class=mi>500</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=nx>newID</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strCMD</span><span class=p>.</span><span class=nf>Result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;topup error:%v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;topup success for user:%v offset:%v\n&#34;</span><span class=p>,</span> <span class=nx>userID</span><span class=p>,</span> <span class=nx>newID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=the-state>The State<a hidden class=anchor aria-hidden=true href=#the-state>#</a></h2><p>The <code>state</code> object is pretty simple, just a plain struct</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>State</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>LatestEventID</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Users</span>         <span class=kd>map</span><span class=p>[</span><span class=kt>int64</span><span class=p>]</span><span class=o>*</span><span class=nx>user</span><span class=p>.</span><span class=nx>User</span>
</span></span><span class=line><span class=cl>	<span class=nx>Items</span>         <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>warehouse</span><span class=p>.</span><span class=nx>Item</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=the-consumer>The Consumer<a hidden class=anchor aria-hidden=true href=#the-consumer>#</a></h2><p>Then the Consumer gets the events => pass the event proper <code>handler</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>consumeEvents</span><span class=p>(</span><span class=nx>events</span> <span class=kd>chan</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Event</span><span class=p>,</span> <span class=nx>handlerFactory</span> <span class=kd>func</span><span class=p>(</span><span class=nx>t</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Type</span><span class=p>)</span> <span class=nx>handler</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>e</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>events</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>h</span> <span class=o>:=</span> <span class=nf>handlerFactory</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nf>GetType</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span> <span class=o>:=</span> <span class=nx>h</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;handle event error eventType:%v err:%v\n&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nf>GetType</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Depend on <code>event.Type</code>, we have different handlers for each event type.
And the <code>handler</code> will handle the business logic then update the <code>state</code></p><pre tabindex=0><code>handler/
 factory.go
 handler.go
 item_add.go
 log.go
 order.go
 topup.go
</code></pre><p><code>handler/topup.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>topupHandler</span><span class=p>)</span> <span class=nf>Handle</span><span class=p>(</span><span class=nx>e</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>topup</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>e</span><span class=p>.(</span><span class=o>*</span><span class=nx>event</span><span class=p>.</span><span class=nx>TopUp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>LatestEventID</span> <span class=p>=</span> <span class=nx>topup</span><span class=p>.</span><span class=nf>GetID</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;incorrect event type&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>u</span><span class=p>,</span> <span class=nx>exist</span> <span class=o>:=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>Users</span><span class=p>[</span><span class=nx>topup</span><span class=p>.</span><span class=nx>UserID</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>exist</span> <span class=p>{</span> <span class=c1>// should have an event to create user before use
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>u</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>UseID</span><span class=p>:</span>   <span class=nx>topup</span><span class=p>.</span><span class=nx>UserID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Balance</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>Users</span><span class=p>[</span><span class=nx>topup</span><span class=p>.</span><span class=nx>UserID</span><span class=p>]</span> <span class=p>=</span> <span class=nx>u</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>u</span><span class=p>.</span><span class=nx>Balance</span> <span class=o>+=</span> <span class=nx>topup</span><span class=p>.</span><span class=nx>Amount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;completed topup %+v \n&#34;</span><span class=p>,</span> <span class=nx>topup</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>handler/item_add.go</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>h</span> <span class=o>*</span><span class=nx>itemAddHandler</span><span class=p>)</span> <span class=nf>Handle</span><span class=p>(</span><span class=nx>e</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>addItem</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>e</span><span class=p>.(</span><span class=o>*</span><span class=nx>event</span><span class=p>.</span><span class=nx>AddItem</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>LatestEventID</span> <span class=p>=</span> <span class=nx>addItem</span><span class=p>.</span><span class=nf>GetID</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;incorrect event type&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>i</span><span class=p>,</span> <span class=nx>exist</span> <span class=o>:=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>Items</span><span class=p>[</span><span class=nx>addItem</span><span class=p>.</span><span class=nx>ItemID</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>exist</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>i</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>warehouse</span><span class=p>.</span><span class=nx>Item</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ID</span><span class=p>:</span>     <span class=nx>addItem</span><span class=p>.</span><span class=nx>ItemID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Price</span><span class=p>:</span>  <span class=nb>uint</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=mi>100</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Remain</span><span class=p>:</span> <span class=nb>uint</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=mi>200</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>Items</span><span class=p>[</span><span class=nx>addItem</span><span class=p>.</span><span class=nx>ItemID</span><span class=p>]</span> <span class=p>=</span> <span class=nx>i</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>i</span><span class=p>.</span><span class=nx>Remain</span> <span class=o>+=</span> <span class=nx>addItem</span><span class=p>.</span><span class=nx>Count</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;completed add item %+v \n&#34;</span><span class=p>,</span> <span class=nx>addItem</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=snapshot>Snapshot<a hidden class=anchor aria-hidden=true href=#snapshot>#</a></h2><p>the <code>snapshot</code> will take the <code>state</code> and save to redis</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>exeSnapshot</span><span class=p>(</span><span class=nx>st</span> <span class=o>*</span><span class=nx>state</span><span class=p>.</span><span class=nx>State</span><span class=p>,</span> <span class=nx>snapshotSrv</span> <span class=nx>snapshot</span><span class=p>.</span><span class=nx>Snapshot</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ticker</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Tick</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span> <span class=o>*</span> <span class=mi>30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ticker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span> <span class=o>:=</span> <span class=nx>snapshotSrv</span><span class=p>.</span><span class=nf>Snapshot</span><span class=p>(</span><span class=nx>st</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;snapshot failed:&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;snapshot success:&#34;</span><span class=p>,</span> <span class=nx>st</span><span class=p>.</span><span class=nx>LatestEventID</span><span class=p>,</span> <span class=s>&#34; at &#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=run>Run<a hidden class=anchor aria-hidden=true href=#run>#</a></h2><p><strong>Require redis running locally</strong></p><h3 id=producer>Producer<a hidden class=anchor aria-hidden=true href=#producer>#</a></h3><p>First, start the producer to insert some events to <code>redis stream</code>
<img loading=lazy src=https://thepracticaldev.s3.amazonaws.com/i/v0scin2iq1cdcnu9nkaw.png alt="Alt Text"></p><h3 id=consumer>Consumer<a hidden class=anchor aria-hidden=true href=#consumer>#</a></h3><p>Now start the consumer to consume events</p><p><img loading=lazy src=https://thepracticaldev.s3.amazonaws.com/i/eueho865f5couulhbnal.png alt="Alt Text">
Because the consumer consumes the events but not backup the state yet.
If you wait for more than 30s, you will see this message from console</p><p><img loading=lazy src=https://thepracticaldev.s3.amazonaws.com/i/0qkcmgzgwlhctk51q3bj.png alt="Alt Text"></p><p>Now if you stop the app and start it again, the application state will restore from the latest snapshot, not reprocess the event again</p><p><img loading=lazy src=https://thepracticaldev.s3.amazonaws.com/i/vxxwbn2hfho3qj1hgi3b.png alt="Alt Text"></p><p>Thank you for reading!
I hope the source code is clean enough for you to understand :scream:</p><h2 id=thoughts>Thoughts<a hidden class=anchor aria-hidden=true href=#thoughts>#</a></h2><p>Did you curious why I name my repository <code>lmax</code>?
By the time I write this post, I&rsquo;m researching about this <a href=https://martinfowler.com/articles/lmax.html>LMAX architecture</a> <a href=https://github.com/LMAX-Exchange/disruptor/wiki>Github</a>.
It&rsquo;s quite interesting. Currently, I fetch new events and push to a <code>channel</code>, we can use <code>LMAX Disruptor</code> to optimize the latency but there is no stable implement of <code>LMAX Disruptor</code> in <code>go</code>.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://felixvo.github.io/posts/2019-11-23-dynamic-programming/><span class=title>« Prev</span><br><span>Dynamic Programming</span></a>
<a class=next href=https://felixvo.github.io/posts/2018-09-13-git-rebase/><span class=title>Next »</span><br><span>Git Rebase, when to use it?</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Event Sourcing with Go and Redis on twitter" href="https://twitter.com/intent/tweet/?text=Event%20Sourcing%20with%20Go%20and%20Redis&url=https%3a%2f%2ffelixvo.github.io%2fposts%2f2019-11-29-event-sourcing-golang-redis%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Event Sourcing with Go and Redis on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffelixvo.github.io%2fposts%2f2019-11-29-event-sourcing-golang-redis%2f&title=Event%20Sourcing%20with%20Go%20and%20Redis&summary=Event%20Sourcing%20with%20Go%20and%20Redis&source=https%3a%2f%2ffelixvo.github.io%2fposts%2f2019-11-29-event-sourcing-golang-redis%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Event Sourcing with Go and Redis on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffelixvo.github.io%2fposts%2f2019-11-29-event-sourcing-golang-redis%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://felixvo.github.io/>Hi</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>